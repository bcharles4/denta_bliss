<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dental Admin Dashboard</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --accent:#3a86ff; --danger:#ef4444;
      --success:#10b981; --radius:12px; --gap:16px; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111827;min-height:100vh}
    .app{display:flex;min-height:100vh}
    /* Sidebar */
    .sidebar{width:260px;background:linear-gradient(180deg,#0f172a,#111827);color:white;padding:20px;flex:0 0 260px}
    .sidebar h1{font-size:18px;margin:0 0 14px}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav a{display:flex;align-items:center;padding:10px;border-radius:8px;color:rgba(255,255,255,0.9);text-decoration:none}
    .nav a.active, .nav a:hover{background:rgba(255,255,255,0.06)}
    .nav a span{margin-left:10px}
    /* Main */
    .main{flex:1;padding:20px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
    .search{flex:1;display:flex;gap:10px;align-items:center}
    .search input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ef;background:white}
    .card-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    .card h3{margin:0 0 6px;font-size:13px;color:var(--muted)}
    .card .value{font-size:20px;font-weight:600}

    .table-wrap{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px solid #eef2f7;font-size:14px}
    th{font-weight:600;color:var(--muted);font-size:13px}
    tr:hover td{background:#fbfdff}
    .btn{display:inline-block;padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#8338ec);color:white}
    .btn-ghost{background:transparent;border:1px solid #e6e9ef}
    .btn-danger{background:var(--danger);color:white}
    .btn-success{background:var(--success);color:white}
    .btn-warning{background:#f59e0b;color:white}
    .btn-info{background:#06b6d4;color:white}
    .small{font-size:12px;padding:6px 8px;border-radius:6px}
    .status-pending{background:#fff7ed;color:#b45309;padding:6px 8px;border-radius:8px}
    .status-confirmed{background:#ecfdf5;color:#065f46;padding:6px 8px;border-radius:8px}
    .status-cancelled{background:#fef2f2;color:#dc2626;padding:6px 8px;border-radius:8px}
    .status-completed{background:#dbeafe;color:#1e40af;padding:6px 8px;border-radius:8px}
    .flex{display:flex;gap:8px;align-items:center}
    /* form */
    .form-row{display:flex;gap:12px;margin-bottom:12px}
    .form-row > *{flex:1}
    input,select,textarea{padding:10px;border-radius:8px;border:1px solid #e6e9ef;background:white}
    textarea{min-height:80px;resize:vertical}
    .footer-note{color:var(--muted);font-size:13px;margin-top:10px}
    /* Toast */
    .toast{position:fixed;top:20px;right:20px;background:var(--success);color:white;padding:12px 16px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;display:none}
    .toast.error{background:var(--danger)}
    .toast.info{background:var(--accent)}
    .toast.warning{background:#f59e0b}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(3,7,18,0.5);align-items:center;justify-content:center;z-index:1000;display:none}
    .modal-content{width:94%;max-width:800px;background:white;padding:24px;border-radius:12px;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-header h3{margin:0;font-size:20px}
    .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted)}
    .medical-history-section{margin:20px 0}
    .medical-history-item{background:#f8fafc;padding:20px;border-radius:8px;border:1px solid #e2e8f0;margin-bottom:16px}
    .medical-history-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
    .medical-history-service{font-size:18px;font-weight:600;color:#1e293b;margin:0}
    .medical-history-date{font-size:14px;color:#64748b;background:#e2e8f0;padding:4px 8px;border-radius:4px}
    .medical-history-details{margin-top:12px}
    .medical-history-row{display:flex;margin-bottom:8px;font-size:14px}
    .medical-history-label{font-weight:600;color:#475569;min-width:80px}
    .medical-history-value{color:#334155}
    .medical-history-notes{margin-top:12px;padding:12px;background:#f1f5f9;border-radius:6px;font-size:14px;color:#475569}
    .no-data{color:#94a3b8;font-style:italic;text-align:center;padding:40px;font-size:16px}
    .back-button{background:var(--accent);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;margin-top:20px}
    /* SMS specific styles */
    .sms-status{display:inline-block;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:500;margin-left:8px}
    .sms-sent{background:#d1fae5;color:#065f46}
    .sms-failed{background:#fee2e2;color:#dc2626}
    .sms-pending{background:#fef3c7;color:#92400e}
    .sms-container{margin-top:20px;padding:20px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0}
    .sms-message{background:#ffffff;border:1px solid #e2e8f0;padding:12px;border-radius:6px;margin:10px 0;font-family:monospace;white-space:pre-wrap;word-break:break-word}
    .phone-input-group{display:flex;gap:10px;margin-bottom:15px}
    .phone-input-group input:first-child{flex:0 0 80px}
    .phone-input-group input:last-child{flex:1}
    .phone-input-group select{flex:0 0 100px}
    .test-sms-section{margin:30px 0;padding:20px;background:#f0f9ff;border-radius:8px;border:1px solid #bae6fd}
    /* responsive */
    @media (max-width:880px){
      .sidebar{display:none}
      .app{flex-direction:column}
      .main{padding:12px}
      .medical-history-header{flex-direction:column;gap:8px}
      .phone-input-group{flex-direction:column}
    }
  </style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <h1>Dental Admin</h1>
    <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-bottom:12px">Manage users & appointments</div>

    <nav class="nav" id="nav">
      <a href="#" data-page="dashboard" class="active"><span>Dashboard</span></a>
      <a href="#" data-page="appointments"><span>Appointments</span></a>
      <a href="#" data-page="users"><span>Users</span></a>
      <a href="#" id="btnSignOut"><span>Sign Out</span></a>
    </nav>

    <div style="margin-top:20px;font-size:12px;color:rgba(255,255,255,0.6)">
      Logged in as: <div id="adminEmail" style="font-weight:600;margin-top:6px"></div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <h2 id="pageTitle" style="margin:0">Dashboard</h2>
        <div class="search" style="max-width:560px">
          <input id="globalSearch" placeholder="Search appointments or users..." />
          <button class="btn btn-ghost" id="btnRefresh">Refresh</button>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn btn-primary" id="btnNewAppointment">+ New Appointment</button>
        <button class="btn btn-success" id="btnSendReminders">Send Email Reminders</button>
        <button class="btn btn-info" id="btnSendSMSReminders">Send SMS Reminders</button>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Dashboard cards -->
    <div id="page-dashboard">
      <div class="card-row">
        <div class="card">
          <h3>Total Appointments</h3>
          <div class="value" id="countAppointments">â€”</div>
        </div>
        <div class="card">
          <h3>Upcoming (next 7d)</h3>
          <div class="value" id="countNext7">â€”</div>
        </div>
        <div class="card">
          <h3>Pending</h3>
          <div class="value" id="countPending">â€”</div>
        </div>
        <div class="card">
          <h3>Users</h3>
          <div class="value" id="countUsers">â€”</div>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">Recent Appointments</h3>
          <div class="flex">
            <button class="btn btn-ghost" id="btnExportCSV">Export CSV</button>
          </div>
        </div>

        <table id="appointmentsTable">
          <thead>
            <tr>
              <th>Date</th><th>Time</th><th>Patient</th><th>Phone</th><th>Service</th><th>Dentist</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Appointments page -->
    <div id="page-appointments" style="display:none">
      <div class="card" style="margin-bottom:12px">
        <h3>Appointments</h3>
        <div class="footer-note">Use search to filter by patient, service, dentist or date.</div>
      </div>

      <div class="table-wrap">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">All Appointments</h3>
          <div class="flex">
            <select id="filterStatus" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef">
              <option value="">All statuses</option>
              <option value="Pending">Pending</option>
              <option value="Confirmed">Confirmed</option>
              <option value="Cancelled">Cancelled</option>
              <option value="Completed">Completed</option>
            </select>
            <button class="btn btn-ghost" id="btnExportAll">Export CSV</button>
          </div>
        </div>

        <table id="allAppointmentsTable">
          <thead>
            <tr>
              <th>Date</th><th>Time</th><th>Patient</th><th>Phone</th><th>Service</th><th>Dentist</th><th>Status</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Users page -->
    <div id="page-users" style="display:none">
      <div class="card" style="margin-bottom:12px">
        <h3>Users</h3>
        <div class="footer-note">Click on user name to view medical/treatment history</div>
      </div>

      <div class="table-wrap">
        <table id="usersTable">
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Face Registered</th><th>Medical History</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- Modal: New appointment (simple) -->
<div id="modalNew" style="display:none;position:fixed;inset:0;background:rgba(3,7,18,0.5);align-items:center;justify-content:center;z-index:1000;">
  <div style="width:94%;max-width:720px;background:white;padding:18px;border-radius:12px;">
    <h3 style="margin-top:0">Create Appointment</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="mDate" placeholder="YYYY-MM-DD" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee">
      <input id="mTime" placeholder="10:00 AM" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee">
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="mPatient" placeholder="Patient name" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee">
      <input id="mEmail" placeholder="Email" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee">
    </div>
    <div class="phone-input-group">
      <select id="mCountryCode" style="padding:8px;border-radius:8px;border:1px solid #eee">
        <option value="+63">ðŸ‡µðŸ‡­ +63</option>
        <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
        <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
        <option value="+65">ðŸ‡¸ðŸ‡¬ +65</option>
        <option value="+60">ðŸ‡²ðŸ‡¾ +60</option>
      </select>
      <input id="mPhone" placeholder="Phone number (for SMS)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee">
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="mService" placeholder="Service" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee">
      <input id="mDentist" placeholder="Dentist" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee">
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <textarea id="mNotes" placeholder="Notes..." style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee"></textarea>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn btn-ghost" id="mCancel">Cancel</button>
      <button class="btn btn-primary" id="mCreate">Create</button>
    </div>
  </div>
</div>

<!-- Modal: Send SMS -->
<div id="modalSendSMS" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Send SMS Reminder</h3>
      <button class="close-btn" id="closeSMSModal">&times;</button>
    </div>
    
    <div class="sms-container">
      <div style="margin-bottom:15px">
        <strong>Recipient:</strong> <span id="smsRecipientName">-</span><br>
        <strong>Phone:</strong> <span id="smsRecipientPhone">-</span><br>
        <strong>Appointment:</strong> <span id="smsAppointmentDetails">-</span>
      </div>
      
      <div style="margin-bottom:15px">
        <label style="display:block;margin-bottom:5px;font-weight:500">Message Template:</label>
        <select id="smsTemplate" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0;margin-bottom:10px">
          <option value="appointment_reminder">Appointment Reminder</option>
          <option value="appointment_confirmation">Appointment Confirmation</option>
          <option value="appointment_cancellation">Appointment Cancellation</option>
          <option value="custom">Custom Message</option>
        </select>
      </div>
      
      <div style="margin-bottom:15px">
        <label style="display:block;margin-bottom:5px;font-weight:500">Message:</label>
        <textarea id="smsMessage" rows="4" placeholder="Enter your message here..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #e2e8f0"></textarea>
        <div class="footer-note">Message will be automatically formatted with appointment details</div>
      </div>
      
      <div class="sms-message" id="smsPreview">
        Preview will appear here...
      </div>
      
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:15px">
        <button class="btn btn-ghost" id="smsCancel">Cancel</button>
        <button class="btn btn-info" id="smsSend">Send SMS</button>
      </div>
    </div>
    
    <div class="test-sms-section">
      <h4 style="margin-top:0">Test SMS Functionality</h4>
      <div style="display:flex;gap:8px;margin-bottom:10px">
        <input id="testPhone" placeholder="Phone number (e.g., 09171234567)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e2e8f0">
        <button class="btn btn-warning" id="testSMS">Send Test SMS</button>
      </div>
      <div class="footer-note">Enter a Philippine phone number to test SMS sending functionality</div>
    </div>
  </div>
</div>

<!-- Modal: Medical/Treatment History -->
<div id="modalMedicalHistory" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="medicalHistoryTitle">Treatment History</h3>
      <button class="close-btn" id="closeMedicalHistory">&times;</button>
    </div>
    
    <div style="margin-bottom:20px">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px">
        <div style="font-size:14px;color:#64748b">
          <strong>Patient:</strong> <span id="medicalPatientName">-</span>
        </div>
        <div style="font-size:14px;color:#64748b">
          <strong>Email:</strong> <span id="medicalPatientEmail">-</span>
        </div>
        <div style="font-size:14px;color:#64748b">
          <strong>Phone:</strong> <span id="medicalPatientPhone">-</span>
        </div>
      </div>
    </div>
    
    <div class="medical-history-section" id="treatmentHistoryContainer">
      <div class="no-data">Loading treatment history...</div>
    </div>
    
    <div style="text-align:center;margin-top:24px">
      <button class="back-button" id="closeMedicalHistoryBtn">BACK</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===================== CONFIG ======================= */
const firebaseConfig = {
  apiKey: "AIzaSyAhAB8p3S2kWTi28qepbUxV8rqPqLAgUkQ",
  authDomain: "dentabliss.firebaseapp.com",
  projectId: "dentabliss",
  storageBucket: "dentabliss.firebasestorage.app",
  messagingSenderId: "781165879537",
  appId: "1:781165879537:web:daad98c54c4ea12195c950",
  measurementId: "G-4TF8DE4T56"
};

// Semaphore API Configuration
const SEMAPHORE_API_KEY = "173c145eb2b7ed71c0f7e91fbfda9619";
const SEMAPHORE_SENDER_NAME = "Semaphore";
const SEMAPHORE_API_URL = "https://api.semaphore.co/api/v4/messages";

// CORS Proxy (for development/testing - you may need to request temporary access)
// Alternative proxies if the first one doesn't work:
// 1. https://corsproxy.io/?
// 2. https://api.allorigins.win/raw?url=
// 3. https://thingproxy.freeboard.io/fetch/
const CORS_PROXY = "https://corsproxy.io/?";

// init
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ===================== UI HELPERS ===================== */
const q = sel => document.querySelector(sel);
const qAll = sel => Array.from(document.querySelectorAll(sel));
const showPage = (pageId) => {
  // Only show/hide pages that actually exist
  const pages = ['dashboard', 'appointments', 'users'];
  pages.forEach(p => {
    const pageElement = q('#page-' + p);
    const navLink = q('#nav a[data-page="' + p + '"]');
    
    if (pageElement) {
      pageElement.style.display = (p === pageId ? '' : 'none');
    }
    
    if (navLink) {
      navLink.classList.toggle('active', p === pageId);
    }
  });
  
  q('#pageTitle').innerText = pageId.charAt(0).toUpperCase() + pageId.slice(1);
};

/* ===================== TOAST ===================== */
function showToast(message, type = 'success') {
  const toast = q('#toast');
  toast.innerText = message;
  toast.className = `toast ${type}`;
  toast.style.display = 'block';
  setTimeout(() => {
    toast.style.display = 'none';
  }, 3000);
}

/* ===================== AUTH UI ===================== */
let currentAdmin = null;

function requireLogin() {
  auth.onAuthStateChanged(user => {
    if (user) {
      currentAdmin = user;
      q('#adminEmail').innerText = user.email || '(no email)';
      // load initial data
      refreshCounts();
      loadRecentAppointments();
      loadAllAppointments();
      loadUsers();
    } else {
      // no user â€” show a simple prompt
      const email = prompt('Admin email:');
      const pass = prompt('Password:');
      if (!email || !pass) return alert('Login cancelled');
      auth.signInWithEmailAndPassword(email, pass)
        .catch(err => alert('Login failed: '+err.message));
    }
  });
}
requireLogin();

/* ========== NAV ========= */
qAll('#nav a[data-page]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    showPage(a.dataset.page);
  });
});
q('#btnSignOut').addEventListener('click', ()=> auth.signOut().then(()=>location.reload()));

/* ========== UTILS ========= */
function formatDate(d){ 
  try{ 
    const dt = new Date(d); 
    if(isNaN(dt)) return d; 
    return dt.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric'
    }); 
  }catch(e){return d;} 
}

function toCSV(rows, cols){
  const esc = v => '"'+String(v||'').replace(/"/g,'""')+'"';
  const head = cols.map(c=>esc(c)).join(',');
  const body = rows.map(r => cols.map(c=>esc(r[c])).join(',')).join('\n');
  return head + '\n' + body;
}

function downloadFile(filename, content){
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(content);
  a.download = filename;
  a.click();
}

// Format phone number for display
function formatPhoneForDisplay(phone) {
  if (!phone) return 'â€”';
  
  // Remove non-digit characters
  const cleaned = phone.replace(/\D/g, '');
  
  // Format Philippine numbers (63XXXXXXXXXX or 09XXXXXXXXX)
  if (cleaned.startsWith('63') && cleaned.length === 12) {
    return `+${cleaned.substring(0, 2)} ${cleaned.substring(2, 5)} ${cleaned.substring(5, 8)} ${cleaned.substring(8)}`;
  } else if (cleaned.startsWith('09') && cleaned.length === 11) {
    return `+63 ${cleaned.substring(1, 4)} ${cleaned.substring(4, 7)} ${cleaned.substring(7)}`;
  }
  
  // Format other numbers
  return phone;
}

// Format phone number for API
function formatPhoneNumber(phone, countryCode = '+63') {
  if (!phone) return '';
  
  // Remove non-digit characters
  const cleaned = phone.replace(/\D/g, '');
  
  // If it starts with 0, convert to +63 format (Philippines)
  if (cleaned.startsWith('0')) {
    return '+63' + cleaned.substring(1);
  }
  
  // If it's already in +63 format
  if (cleaned.startsWith('63')) {
    return '+' + cleaned;
  }
  
  // Add country code if not present
  return countryCode + cleaned;
}

// Validate phone number
function validatePhoneNumber(phone) {
  if (!phone) return false;
  // Remove all non-digit characters
  const cleaned = phone.replace(/\D/g, '');
  // Check if it has at least 10 digits
  return cleaned.length >= 10;
}

/* ===================== SMS FUNCTIONS ===================== */
async function sendSMS(phoneNumber, message) {
  try {
    showToast('Sending SMS...', 'info');
    
    // Format phone number
    const formattedPhone = formatPhoneNumber(phoneNumber);
    
    if (!validatePhoneNumber(formattedPhone)) {
      throw new Error('Invalid phone number format. Must be at least 10 digits.');
    }
    
    console.log('Sending SMS to:', formattedPhone);
    console.log('Message:', message.substring(0, 50) + '...');
    
    // Try different CORS proxies if one fails
    const corsProxies = [
      'https://corsproxy.io/?',
      'https://api.allorigins.win/raw?url=',
      'https://thingproxy.freeboard.io/fetch/'
    ];
    
    let lastError = null;
    
    for (const proxy of corsProxies) {
      try {
        console.log('Trying proxy:', proxy);
        
        const response = await fetch(proxy + encodeURIComponent(SEMAPHORE_API_URL), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            apikey: SEMAPHORE_API_KEY,
            number: formattedPhone,
            message: message,
            sendername: SEMAPHORE_SENDER_NAME
          })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`Proxy returned status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('SMS API response:', result);
        
        if (result[0] && result[0].status === 'Pending') {
          showToast('SMS sent successfully!');
          return { success: true, data: result };
        } else {
          throw new Error(result[0]?.message || 'SMS not sent');
        }
      } catch (proxyError) {
        console.log(`Proxy ${proxy} failed:`, proxyError.message);
        lastError = proxyError;
        continue; // Try next proxy
      }
    }
    
    // If all proxies failed, try direct with mode: 'no-cors' (limited)
    console.log('All proxies failed, trying no-cors mode...');
    
    // Create a form submission as fallback (this won't give us a response but might work)
    const manualInstructions = `
    SMS SENDING INSTRUCTIONS:
    
    1. Open: https://semaphore.co/api
    2. Use these parameters:
       - API Key: ${SEMAPHORE_API_KEY.substring(0, 10)}...
       - Number: ${formattedPhone}
       - Message: ${message.substring(0, 100)}...
       - Sender Name: ${SEMAPHORE_SENDER_NAME}
    
    3. OR use curl command:
    curl -X POST https://api.semaphore.co/api/v4/messages \\
      -H "Content-Type: application/json" \\
      -d '{
        "apikey": "${SEMAPHORE_API_KEY}",
        "number": "${formattedPhone}",
        "message": "${message.replace(/"/g, '\\"')}",
        "sendername": "${SEMAPHORE_SENDER_NAME}"
      }'
    `;
    
    console.log(manualInstructions);
    
    // Show user the manual instructions
    alert(`SMS ready to send!\n\nPhone: ${formattedPhone}\n\nCopy this message:\n${message}\n\nUse the Semaphore API console or curl command to send.`);
    
    // Simulate success for demo
    return { 
      success: true, 
      data: { 
        message: 'SMS prepared - use manual instructions above',
        manualInstructions: manualInstructions
      } 
    };
    
  } catch (error) {
    console.error('Error sending SMS:', error);
    showToast(`SMS failed: ${error.message}`, 'error');
    return { success: false, error: error.message };
  }
}

async function sendAppointmentReminderSMS(appointment) {
  try {
    if (!appointment.patientPhone && !appointment.phone) {
      throw new Error('No phone number found for patient');
    }
    
    const phoneNumber = appointment.patientPhone || appointment.phone;
    const formattedDate = formatDate(appointment.date);
    
    // Create SMS message
    const message = `Hello ${appointment.patientName}! This is a reminder for your dental appointment at DentaBliss on ${formattedDate} at ${appointment.time}. Please arrive 10 minutes early. Call us at (02) 8888-9999 if you need to reschedule.`;
    
    return await sendSMS(phoneNumber, message);
  } catch (error) {
    console.error('Error sending appointment reminder SMS:', error);
    return { success: false, error: error.message };
  }
}

async function sendTomorrowSMSReminders() {
  try {
    showToast('Sending SMS reminders for tomorrow...', 'info');
    
    // Get tomorrow's date
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().slice(0, 10);
    
    // Get tomorrow's appointments
    const appointmentsSnapshot = await db.collection('appointments')
      .where('date', '==', tomorrowStr)
      .where('status', 'in', ['Confirmed', 'Pending'])
      .get();
    
    if (appointmentsSnapshot.empty) {
      showToast('No appointments found for tomorrow', 'warning');
      return { success: true, sent: 0, total: 0 };
    }
    
    let sentCount = 0;
    let totalCount = appointmentsSnapshot.size;
    
    for (const doc of appointmentsSnapshot.docs) {
      const appointment = { id: doc.id, ...doc.data() };
      
      if (appointment.patientPhone || appointment.phone) {
        const result = await sendAppointmentReminderSMS(appointment);
        
        if (result.success) {
          sentCount++;
          // Update appointment with SMS sent timestamp
          await db.collection('appointments').doc(appointment.id).update({
            smsSent: firebase.firestore.FieldValue.serverTimestamp(),
            smsStatus: 'sent'
          });
        } else {
          // Update with failed status
          await db.collection('appointments').doc(appointment.id).update({
            smsStatus: 'failed',
            smsError: result.error
          });
        }
        
        // Delay to avoid rate limiting
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }
    
    showToast(`Successfully sent ${sentCount} out of ${totalCount} SMS reminders!`);
    return { success: true, sent: sentCount, total: totalCount };
  } catch (error) {
    console.error('Error sending tomorrow SMS reminders:', error);
    showToast('Error sending tomorrow SMS reminders', 'error');
    return { success: false, error: error.message };
  }
}

/* ===================== SMS MODAL FUNCTIONS ===================== */
let currentSMSAppointment = null;

function openSMSModal(appointment) {
  currentSMSAppointment = appointment;
  
  // Populate modal fields
  q('#smsRecipientName').textContent = appointment.patientName || appointment.patient || 'Unknown';
  q('#smsRecipientPhone').textContent = formatPhoneForDisplay(appointment.patientPhone || appointment.phone) || 'No phone number';
  q('#smsAppointmentDetails').textContent = `${appointment.service || 'Dental Appointment'} on ${appointment.date} at ${appointment.time}`;
  
  // Set default message based on template
  updateSMSMessage();
  
  // Show modal
  q('#modalSendSMS').style.display = 'flex';
}

function updateSMSMessage() {
  const template = q('#smsTemplate').value;
  const appointment = currentSMSAppointment;
  const formattedDate = formatDate(appointment.date);
  
  let message = '';
  
  switch (template) {
    case 'appointment_reminder':
      message = `Hello ${appointment.patientName}! This is a reminder for your dental appointment at DentaBliss on ${formattedDate} at ${appointment.time}. Please arrive 10 minutes early. Call us at (02) 8888-9999 if you need to reschedule.`;
      break;
    case 'appointment_confirmation':
      message = `Hello ${appointment.patientName}! Your appointment for ${appointment.service} has been confirmed for ${formattedDate} at ${appointment.time}. Dr. ${appointment.dentist} will see you. Please arrive 10 minutes early.`;
      break;
    case 'appointment_cancellation':
      message = `Hello ${appointment.patientName}! Your appointment for ${formattedDate} at ${appointment.time} has been cancelled. Please call us at (02) 8888-9999 to reschedule.`;
      break;
    default:
      message = q('#smsMessage').value || '';
  }
  
  q('#smsMessage').value = message;
  updateSMSPreview();
}

function updateSMSPreview() {
  const message = q('#smsMessage').value;
  const charCount = message.length;
  const smsCount = Math.ceil(charCount / 160);
  
  q('#smsPreview').innerHTML = `
    <strong>Preview (${charCount} chars, ${smsCount} SMS):</strong><br>
    ${message.replace(/\n/g, '<br>')}
  `;
}

// Initialize SMS modal event listeners
function initSMSModal() {
  q('#smsTemplate').addEventListener('change', updateSMSMessage);
  q('#smsMessage').addEventListener('input', updateSMSPreview);
  
  q('#closeSMSModal').addEventListener('click', () => {
    q('#modalSendSMS').style.display = 'none';
    currentSMSAppointment = null;
  });
  
  q('#smsCancel').addEventListener('click', () => {
    q('#modalSendSMS').style.display = 'none';
    currentSMSAppointment = null;
  });
  
  q('#smsSend').addEventListener('click', async () => {
    const appointment = currentSMSAppointment;
    const message = q('#smsMessage').value.trim();
    
    if (!message) {
      showToast('Please enter a message', 'error');
      return;
    }
    
    const phoneNumber = appointment.patientPhone || appointment.phone;
    if (!phoneNumber) {
      showToast('No phone number found for this patient', 'error');
      return;
    }
    
    try {
      const result = await sendSMS(phoneNumber, message);
      
      if (result.success) {
        // Update appointment with SMS sent info
        await db.collection('appointments').doc(appointment.id).update({
          smsSent: firebase.firestore.FieldValue.serverTimestamp(),
          smsStatus: 'sent',
          lastSMSMessage: message.substring(0, 100)
        });
        
        q('#modalSendSMS').style.display = 'none';
        showToast('SMS sent successfully!');
        
        // Refresh tables
        loadRecentAppointments();
        loadAllAppointments();
      }
    } catch (error) {
      showToast(`Failed to send SMS: ${error.message}`, 'error');
    }
  });
  
  // Test SMS functionality
  q('#testSMS').addEventListener('click', async () => {
    const testPhone = q('#testPhone').value.trim();
    
    if (!testPhone) {
      showToast('Please enter a phone number', 'error');
      return;
    }
    
    const testMessage = `DentaBliss Test: This is a test message from the dental admin system. If you received this, SMS integration is working correctly.`;
    
    try {
      const result = await sendSMS(testPhone, testMessage);
      
      if (result.success) {
        showToast('Test SMS sent successfully!');
      }
    } catch (error) {
      showToast(`Test SMS failed: ${error.message}`, 'error');
    }
  });
}

/* ========== TREATMENT HISTORY FUNCTIONS ========= */
async function showTreatmentHistory(userName, userEmail, userPhone) {
  q('#medicalHistoryTitle').innerText = `Treatment History: ${userName}`;
  q('#medicalPatientName').innerText = userName;
  q('#medicalPatientEmail').innerText = userEmail || 'No email';
  q('#medicalPatientPhone').innerText = formatPhoneForDisplay(userPhone) || 'No phone';
  
  const container = q('#treatmentHistoryContainer');
  container.innerHTML = '<div class="no-data">Loading treatment history...</div>';
  
  try {
    const appointmentSnapshot = await db.collection('appointments')
      .where('patientEmail', '==', userEmail)
      .orderBy('date', 'desc')
      .get();
    
    if (!appointmentSnapshot.empty) {
      const appointments = appointmentSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      const today = new Date().toISOString().slice(0,10);
      const pastAppointments = appointments.filter(appt => appt.date <= today || appt.status === 'Completed');
      
      if (pastAppointments.length > 0) {
        container.innerHTML = '';
        
        pastAppointments.forEach(appt => {
          const historyItem = document.createElement('div');
          historyItem.className = 'medical-history-item';
          
          const formattedDate = formatDate(appt.date);
          const statusClass = appt.status?.toLowerCase() || 'pending';
          
          const smsStatus = appt.smsStatus;
          let smsBadge = '';
          if (smsStatus === 'sent') {
            smsBadge = '<span class="sms-status sms-sent">SMS Sent</span>';
          } else if (smsStatus === 'failed') {
            smsBadge = '<span class="sms-status sms-failed">SMS Failed</span>';
          }
          
          historyItem.innerHTML = `
            <div class="medical-history-header">
              <h4 class="medical-history-service">${appt.service || 'Dental Treatment'} ${smsBadge}</h4>
              <div class="medical-history-date">${formattedDate} at ${appt.time || ''}</div>
            </div>
            
            <div class="medical-history-details">
              <div class="medical-history-row">
                <span class="medical-history-label">Date:</span>
                <span class="medical-history-value">${appt.date || 'N/A'}</span>
              </div>
              
              <div class="medical-history-row">
                <span class="medical-history-label">Time:</span>
                <span class="medical-history-value">${appt.time || 'N/A'}</span>
              </div>
              
              <div class="medical-history-row">
                <span class="medical-history-label">Dentist:</span>
                <span class="medical-history-value">${appt.dentist || 'N/A'}</span>
              </div>
              
              <div class="medical-history-row">
                <span class="medical-history-label">Status:</span>
                <span class="medical-history-value">
                  <span class="status-${statusClass}" style="display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px">
                    ${appt.status || 'Pending'}
                  </span>
                </span>
              </div>
            </div>
            
            ${appt.notes ? `
            <div class="medical-history-notes">
              <strong>Notes:</strong> ${appt.notes}
            </div>
            ` : ''}
            
            <div style="border-top:1px dashed #e2e8f0;margin-top:16px;padding-top:8px"></div>
          `;
          
          container.appendChild(historyItem);
        });
      } else {
        container.innerHTML = '<div class="no-data">No treatment history found for this patient</div>';
      }
    } else {
      container.innerHTML = '<div class="no-data">No appointments found for this patient</div>';
    }
    
    q('#modalMedicalHistory').style.display = 'flex';
    
  } catch (error) {
    console.error('Error loading treatment history:', error);
    container.innerHTML = '<div class="no-data">Error loading treatment history. Please try again.</div>';
    showToast('Error loading treatment history', 'error');
    q('#modalMedicalHistory').style.display = 'flex';
  }
}

window.showTreatmentHistory = showTreatmentHistory;

/* ========== EMAIL REMINDER FUNCTIONS ========= */
async function sendAppointmentReminder(appointmentId) {
  try {
    showToast('Sending reminder email...', 'info');
    
    const response = await fetch('https://us-central1-dentabliss.cloudfunctions.net/sendAppointmentReminder', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        appointmentId: appointmentId
      })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      showToast('Reminder email sent successfully!');
      return true;
    } else {
      showToast('Failed to send reminder email: ' + (result.error || 'Unknown error'), 'error');
      return false;
    }
  } catch (error) {
    console.error('Error sending reminder:', error);
    showToast('Error sending reminder email', 'error');
    return false;
  }
}

async function sendTomorrowReminders() {
  try {
    showToast('Sending reminders for tomorrow...', 'info');
    
    const response = await fetch('https://us-central1-dentabliss.cloudfunctions.net/sendTomorrowReminders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      showToast(`Successfully sent ${result.results?.filter(r => r.success).length || 0} reminders!`);
      return true;
    } else {
      showToast('Failed to send tomorrow reminders: ' + (result.error || 'Unknown error'), 'error');
      return false;
    }
  } catch (error) {
    console.error('Error sending tomorrow reminders:', error);
    showToast('Error sending tomorrow reminders', 'error');
    return false;
  }
}

/* ===================== APPOINTMENTS ===================== */
async function refreshCounts(){
  try{
    const snapTotal = await db.collection('appointments').get();
    q('#countAppointments').innerText = snapTotal.size;

    const today = new Date(); const next7 = new Date(); next7.setDate(today.getDate()+7);
    const sToday = today.toISOString().slice(0,10);
    const sNext7 = next7.toISOString().slice(0,10);
    const snapNext = await db.collection('appointments')
      .where('date','>=', sToday)
      .where('date','<=', sNext7)
      .get();
    q('#countNext7').innerText = snapNext.size;

    const snapPending = await db.collection('appointments').where('status','==','Pending').get();
    q('#countPending').innerText = snapPending.size;

    const snapUsers = await db.collection('users').get();
    q('#countUsers').innerText = snapUsers.size;
  }catch(e){console.error(e)}
}

function createActionButton(text, cls, handler){ 
  const b=document.createElement('button'); 
  b.className='small '+cls; 
  b.innerText=text; 
  b.onclick=handler; 
  b.style.marginRight = '4px';
  b.style.marginBottom = '4px';
  return b; 
}

async function loadRecentAppointments(limit=8){
  const tbody = q('#appointmentsTable tbody');
  tbody.innerHTML = '<tr><td colspan="8">Loadingâ€¦</td></tr>';
  try{
    const today = new Date().toISOString().slice(0,10);
    const snap = await db.collection('appointments')
      .where('date', '>=', today)
      .orderBy('date')
      .orderBy('time')
      .limit(limit)
      .get();

    const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    if(!rows.length) tbody.innerHTML = '<tr><td colspan="8">No recent appointments</td></tr>';
    else {
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        const statusClass = `status-${(r.status || 'pending').toLowerCase()}`;
        
        const phoneToCheck = r.patientPhone || r.phone;
        const phoneDisplay = formatPhoneForDisplay(phoneToCheck);
        
        tr.innerHTML = `
          <td>${r.date||''}</td>
          <td>${r.time||''}</td>
          <td>${r.patientName||r.patient || 'â€”'}</td>
          <td>${phoneDisplay}</td>
          <td>${r.service||''}</td>
          <td>${r.dentist||''}</td>
          <td><span class="${statusClass}">${r.status||'Pending'}</span></td>
          <td></td>
        `;
        const actionsCell = tr.querySelector('td:last-child');
        
        actionsCell.style.minWidth = '200px';

        if (r.status !== 'Confirmed') {
          actionsCell.appendChild(createActionButton('Confirm','btn-primary', async ()=>{
            await db.collection('appointments').doc(r.id).update({
              status:'Confirmed', 
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await sendAppointmentReminder(r.id);
            await refreshCounts(); 
            loadRecentAppointments(limit); 
            loadAllAppointments();
          }));
        }

        if (r.status !== 'Cancelled') {
          actionsCell.appendChild(createActionButton('Cancel','btn-ghost', async ()=>{
            await db.collection('appointments').doc(r.id).update({
              status:'Cancelled', 
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await refreshCounts(); 
            loadRecentAppointments(limit); 
            loadAllAppointments();
          }));
        }

        const appointmentDate = new Date(r.date);
        const todayDate = new Date();
        if (r.status === 'Confirmed' && appointmentDate < todayDate) {
          actionsCell.appendChild(createActionButton('Complete','btn-success', async ()=>{
            await db.collection('appointments').doc(r.id).update({
              status:'Completed', 
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await refreshCounts(); 
            loadRecentAppointments(limit); 
            loadAllAppointments();
          }));
        }

        // SMS button always visible
        actionsCell.appendChild(createActionButton('SMS','btn-info', async ()=>{
          await openSMSModal(r);
        }));

        actionsCell.appendChild(createActionButton('Email','btn-success', async ()=>{
          await sendAppointmentReminder(r.id);
        }));

        actionsCell.appendChild(createActionButton('Delete','btn-danger', async ()=>{
          if(confirm('Delete appointment?')){ 
            await db.collection('appointments').doc(r.id).delete(); 
            await refreshCounts(); 
            loadRecentAppointments(limit); 
            loadAllAppointments(); 
          }
        }));

        tbody.appendChild(tr);
      });
    }
  }catch(e){ console.error(e); tbody.innerHTML = '<tr><td colspan="8">Error loading</td></tr>'; }
}

async function loadAllAppointments(){
  const tbody = q('#allAppointmentsTable tbody');
  tbody.innerHTML = '<tr><td colspan="8">Loadingâ€¦</td></tr>';
  try{
    const snap = await db.collection('appointments').orderBy('date').orderBy('time').get();
    const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    if(!rows.length) tbody.innerHTML = '<tr><td colspan="8">No appointments</td></tr>';
    else {
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        const statusClass = `status-${(r.status || 'pending').toLowerCase()}`;
        
        const phoneToCheck = r.patientPhone || r.phone;
        const phoneDisplay = formatPhoneForDisplay(phoneToCheck);
        
        tr.innerHTML = `
          <td>${r.date||''}</td>
          <td>${r.time||''}</td>
          <td>${r.patientName||r.patient||''}</td>
          <td>${phoneDisplay}</td>
          <td>${r.service||''}</td>
          <td>${r.dentist||''}</td>
          <td><span class="${statusClass}">${r.status||'Pending'}</span></td>
          <td></td>`;
        const cell = tr.querySelector('td:last-child');
        
        cell.style.minWidth = '200px';
        
        if (r.status !== 'Confirmed') {
          cell.appendChild(createActionButton('Confirm','btn-primary', async ()=>{
            await db.collection('appointments').doc(r.id).update({
              status:'Confirmed', 
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await sendAppointmentReminder(r.id);
            await refreshCounts(); 
            loadRecentAppointments(); 
            loadAllAppointments();
          }));
        }
        
        if (r.status !== 'Cancelled') {
          cell.appendChild(createActionButton('Cancel','btn-ghost', async ()=>{
            await db.collection('appointments').doc(r.id).update({
              status:'Cancelled', 
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await refreshCounts(); 
            loadRecentAppointments(); 
            loadAllAppointments();
          }));
        }

        const appointmentDate = new Date(r.date);
        const todayDate = new Date();
        if (r.status === 'Confirmed' && appointmentDate < todayDate) {
          cell.appendChild(createActionButton('Complete','btn-success', async ()=>{
            await db.collection('appointments').doc(r.id).update({
              status:'Completed', 
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await refreshCounts(); 
            loadRecentAppointments(); 
            loadAllAppointments();
          }));
        }
        
        // SMS button always visible
        cell.appendChild(createActionButton('SMS','btn-info', async ()=>{
          await openSMSModal(r);
        }));
        
        cell.appendChild(createActionButton('Email','btn-success', async ()=>{
          await sendAppointmentReminder(r.id);
        }));
        
        cell.appendChild(createActionButton('Delete','btn-danger', async ()=>{
          if(confirm('Delete appointment?')){ 
            await db.collection('appointments').doc(r.id).delete(); 
            await refreshCounts(); 
            loadRecentAppointments(); 
            loadAllAppointments(); 
          }
        }));
        
        tbody.appendChild(tr);
      });
    }
  }catch(e){ console.error(e); tbody.innerHTML = '<tr><td colspan="8">Error loading</td></tr>'; }
}

/* ===================== USERS ===================== */
async function loadUsers(){
  const tbody = q('#usersTable tbody');
  tbody.innerHTML = '<tr><td colspan="6">Loadingâ€¦</td></tr>';
  try{
    const snap = await db.collection('users').orderBy('name').get();
    const rows = snap.docs.map(d=>({id:d.id,...d.data()}));
    if(!rows.length) tbody.innerHTML = '<tr><td colspan="6">No users</td></tr>';
    else {
      tbody.innerHTML = '';
      rows.forEach(u=>{
        const tr=document.createElement('tr');
        
        const userName = u.name || 'User';
        const userEmail = u.email || '';
        const userPhone = u.phone || u.mobile || '';
        
        tr.innerHTML = `
          <td>
            <a href="#" style="color:var(--accent);text-decoration:none;font-weight:500" 
               onclick="event.preventDefault(); showTreatmentHistory('${userName.replace(/'/g, "\\'")}', '${userEmail.replace(/'/g, "\\'")}', '${userPhone.replace(/'/g, "\\'")}')">
              ${userName}
            </a>
          </td>
          <td>${userEmail}</td>
          <td>${formatPhoneForDisplay(userPhone) || 'â€”'}</td>
          <td>${u.faceData ? 'Yes':'No'}</td>
          <td>
            <button class="btn small btn-warning" onclick="showTreatmentHistory('${userName.replace(/'/g, "\\'")}', '${userEmail.replace(/'/g, "\\'")}', '${userPhone.replace(/'/g, "\\'")}')">
              View History
            </button>
          </td>
          <td></td>`;
        
        const cell = tr.querySelector('td:last-child');
        cell.appendChild(createActionButton('Delete','btn-danger', async ()=>{
          if(confirm('Delete user? This will not revoke auth record.')) {
            await db.collection('users').doc(u.id).delete();
            await loadUsers();
            await refreshCounts();
          }
        }));
        tbody.appendChild(tr);
      });
    }
  }catch(e){ console.error(e); tbody.innerHTML = '<tr><td colspan="6">Error loading</td></tr>'; }
}

/* ===================== CREATE APPOINTMENT (modal) ===================== */
q('#btnNewAppointment').addEventListener('click', ()=> {
  q('#modalNew').style.display = 'flex';
  q('#mDate').value = '';
  q('#mTime').value = '';
  q('#mPatient').value = '';
  q('#mEmail').value = '';
  q('#mPhone').value = '';
  q('#mService').value = '';
  q('#mDentist').value = '';
  q('#mNotes').value = '';
});

q('#mCancel').addEventListener('click', ()=> q('#modalNew').style.display = 'none');
q('#mCreate').addEventListener('click', async ()=>{
  const date=q('#mDate').value.trim(), time=q('#mTime').value.trim(), patient=q('#mPatient').value.trim();
  const email=q('#mEmail').value.trim(), phone=q('#mPhone').value.trim(), countryCode=q('#mCountryCode').value;
  const service=q('#mService').value.trim(), dentist=q('#mDentist').value.trim(), notes=q('#mNotes').value.trim();
  
  if(!date||!time||!patient){ return alert('Date, time and patient required'); }
  
  const id = db.collection('appointments').doc().id;
  const fullPhone = phone ? countryCode + phone.replace(/\D/g, '') : '';
  
  await db.collection('appointments').doc(id).set({
    appointmentId: id,
    userId: 'admin-created',
    patientName: patient,
    patientEmail: email || '',
    patientPhone: fullPhone,
    service: service || '',
    dentist: dentist || '',
    date: date,
    time: time,
    notes: notes || '',
    status: 'Pending',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  
  q('#modalNew').style.display = 'none';
  showToast('Appointment created successfully!');
  await refreshCounts(); loadRecentAppointments(); loadAllAppointments();
});

/* ========== SEND REMINDERS ========= */
q('#btnSendReminders').addEventListener('click', async () => {
  if (confirm('Send reminder emails for all tomorrow\'s confirmed appointments?')) {
    await sendTomorrowReminders();
  }
});

q('#btnSendSMSReminders').addEventListener('click', async () => {
  if (confirm('Send SMS reminders for all tomorrow\'s confirmed appointments?')) {
    await sendTomorrowSMSReminders();
  }
});

/* ========== MEDICAL HISTORY MODAL CONTROLS ========= */
q('#closeMedicalHistory').addEventListener('click', ()=> q('#modalMedicalHistory').style.display = 'none');
q('#closeMedicalHistoryBtn').addEventListener('click', ()=> q('#modalMedicalHistory').style.display = 'none');

q('#modalMedicalHistory').addEventListener('click', (e) => {
  if (e.target === q('#modalMedicalHistory')) {
    q('#modalMedicalHistory').style.display = 'none';
  }
});

[q('#modalNew'), q('#modalSendSMS')].forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
      if (modal.id === 'modalSendSMS') {
        currentSMSAppointment = null;
      }
    }
  });
});

/* ========== SEARCH / FILTER / EXPORT ========= */
q('#globalSearch').addEventListener('input', (e)=>{
  const term = e.target.value.toLowerCase();
  filterTables(term);
});

function filterTables(term){
  qAll('#appointmentsTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(term) ? '' : 'none';
  });
  qAll('#allAppointmentsTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(term) ? '' : 'none';
  });
  qAll('#usersTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(term) ? '' : 'none';
  });
}

q('#btnRefresh').addEventListener('click', async ()=>{
  await refreshCounts(); loadRecentAppointments(); loadAllAppointments(); loadUsers();
  showToast('Data refreshed!');
});

q('#filterStatus').addEventListener('change', (e)=>{
  const val = e.target.value;
  qAll('#allAppointmentsTable tbody tr').forEach(tr=>{
    tr.style.display = (!val || tr.innerText.includes(val)) ? '' : 'none';
  });
});

q('#btnExportCSV').addEventListener('click', async ()=>{
  const rows = Array.from(document.querySelectorAll('#appointmentsTable tbody tr')).map(tr=>{
    const cols = tr.querySelectorAll('td');
    return { 
      date: cols[0].innerText, 
      time: cols[1].innerText, 
      patient: cols[2].innerText, 
      phone: cols[3].innerText,
      service: cols[4].innerText, 
      dentist: cols[5].innerText, 
      status: cols[6].innerText 
    };
  }).filter(r=>r.date);
  const csv = toCSV(rows, ['date','time','patient','phone','service','dentist','status']);
  downloadFile('appointments.csv', csv);
  showToast('CSV exported successfully!');
});

q('#btnExportAll').addEventListener('click', async ()=>{
  const rows = Array.from(document.querySelectorAll('#allAppointmentsTable tbody tr')).map(tr=>{
    const cols = tr.querySelectorAll('td');
    return { 
      date: cols[0].innerText, 
      time: cols[1].innerText, 
      patient: cols[2].innerText, 
      phone: cols[3].innerText,
      service: cols[4].innerText, 
      dentist: cols[5].innerText, 
      status: cols[6].innerText,
    };
  }).filter(r=>r.date);
  const csv = toCSV(rows, ['date','time','patient','phone','service','dentist','status']);
  downloadFile('appointments_all.csv', csv);
  showToast('All appointments CSV exported!');
});

/* ========== INITIAL load ========== */
async function initialLoad(){
  showPage('dashboard');
  initSMSModal();
}
initialLoad();
</script>

</body>
</html>